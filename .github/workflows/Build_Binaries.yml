name: Build Binaaries

on:
  # push:
  #   branches: [ main ]
  #   tags:
  #     - 'v*'
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:

jobs:
  # Build llama-cpp-python wheels
  build-wheels:
    strategy:
      matrix:
        include:
          # macOS with Metal
          - os: macos-latest
            name: macOS-Metal
            cmake_args: "-DGGML_METAL=on"
            wheel_name: macos-metal
            python_version: "3.12"
          # Linux with CUDA
          - os: ubuntu-latest
            name: Linux-CUDA
            cmake_args: "-DGGML_CUDA=on -DGGML_CUDA_FORCE_CUBLAS=on"
            wheel_name: linux-cuda
            python_version: "3.12"
            cuda: "13.0.0"
          # Linux with Vulkan
          - os: ubuntu-latest
            name: Linux-Vulkan
            cmake_args: "-DGGML_VULKAN=on"
            wheel_name: linux-vulkan
            python_version: "3.12"
          # Windows with CUDA
          - os: windows-latest
            name: Windows-CUDA
            cmake_args: "-DGGML_CUDA=on"
            wheel_name: windows-cuda
            python_version: "3.12"
            cuda: "13.0.0"
          # Linux with Vulkan
          - os: windows-latest
            name: Windows-Vulkan
            cmake_args: "-DGGML_VULKAN=on"
            wheel_name: windows-vulkan
            python_version: "3.12"

    runs-on: ${{ matrix.os }}
    name: Build Wheel - ${{ matrix.name }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python_version }}

    # Platform-specific setup
    - name: Install CUDA Toolkit (CUDA builds)
      if: contains(matrix.cmake_args, 'CUDA')
      uses: nvidia/cuda-toolkit@v2
      with:
        cuda: ${{ matrix.cuda }}   # pulls the value from the matrix

    - name: Install Vulkan SDK (Vulkan builds)
      if: contains(matrix.cmake_args, 'VULKAN')
      uses: humbletim/setup-vulkan-sdk@v1.2.0
      with:
        vulkan-query-version: 1.3.275   # or latest
        vulkan-components: Vulkan-Headers, Vulkan-ValidationLayers, Vulkan-Tools
        vulkan-use-cache: true

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel setuptools build

    - name: Build llama-cpp-python wheel
      env:
        CMAKE_ARGS: ${{ matrix.cmake_args }}
      run: |
        pip wheel llama-cpp-python --no-deps -w ./wheels

    - name: Upload wheel artifact
      uses: actions/upload-artifact@v4
      with:
        name: wheel-${{ matrix.wheel_name }}
        path: wheels/*.whl
        retention-days: 7

  # Build Flet App using Wheels
  build-flet-apps:
    needs: build-wheels
    strategy:
      matrix:
        include:
          # macOS app with Metal wheel
          - os: macos-latest
            wheel_artifact: wheel-macos-metal
            platform: macos
            app_name: WebSearchAI-macOS
            
          # Linux app with CUDA wheel
          - os: ubuntu-latest
            wheel_artifact: wheel-linux-cuda
            platform: linux
            app_name: WebSearchAI-Linux-CUDA
            
          # Linux app with Vulkan wheel
          - os: ubuntu-latest
            wheel_artifact: wheel-linux-vulkan
            platform: linux
            app_name: WebSearchAI-Linux-Vulkan
            
          # Windows app with CUDA wheel
          - os: windows-latest
            wheel_artifact: wheel-windows-cuda
            platform: windows
            app_name: WebSearchAI-Windows-CUDA
            
          # Windows app with Vulkan wheel
          - os: windows-latest
            wheel_artifact: wheel-windows-vulkan
            platform: windows
            app_name: WebSearchAI-Windows-Vulkan

    runs-on: ${{ matrix.os }}
    name: Build App - ${{ matrix.app_name }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Download wheel
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.wheel_artifact }}
        path: ./wheels

    - name: Create temporary pyproject.toml with wheel reference
      run: |
        # Get the wheel filename
        WHEEL_FILE=$(ls wheels/*.whl | head -n 1)
        WHEEL_PATH=$(realpath $WHEEL_FILE)
        
        # Create a modified pyproject.toml that references the local wheel
        cat > pyproject_build.toml << EOF
        [project]
        name = "WebSearch AI"
        version = "0.1.0"
        description = "WebSearch AI Application"
        dependencies = [
            "flet>=0.23.0",
            "llama-cpp-python @ file:///${WHEEL_PATH}",
            "httpx",
            "beautifulsoup4",
            "readability-lxml",
            "pypng",
            "numpy",
            
        ]

        [project.optional-dependencies]
        dev = ["pytest", "black", "flake8"]

        [build-system]
        requires = ["flit_core >=3.2,<4"]
        build-backend = "flit_core.buildapi"
        EOF
        
        # Backup original and use the build version
        mv pyproject.toml pyproject_original.toml || true
        mv pyproject_build.toml pyproject.toml
      shell: bash

    - name: Install Flet and dependencies
      run: |
        pip install flet
        pip install -e .

    - name: Build Flet app
      run: |
        flet build ${{ matrix.platform }} --project-name ${{ matrix.app_name }}

    - name: Upload app artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-${{ matrix.app_name }}
        path: |
          build/${{ matrix.platform }}/*
        retention-days: 30

  # Create release with all artifacts
  release:
    needs: build-flet-apps
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all app artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: app-*
        path: apps
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          apps/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
