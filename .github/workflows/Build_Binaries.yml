name: Build Binaries

on:
  # push:
  #   branches: [ main ]
  #   tags:
  #     - 'v*'
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:

jobs:
  # Build llama-cpp-python wheels
  # build-wheels:
  #   strategy:
  #     matrix:
  #       include:
  #         # macOS with Metal
  #         - os: macos-latest
  #           name: macOS-Metal
  #           # cmake_args: "-DGGML_METAL=on"
  #           cmake_args: "-DGGML_METAL=on -DGGML_NATIVE=off -DCMAKE_C_FLAGS=-mcpu=apple-m2 -DCMAKE_CXX_FLAGS=-mcpu=apple-m2"
  #           # cmake_args: "-DGGML_METAL=on -DCMAKE_C_FLAGS=-mcpu=apple-m2 -DCMAKE_CXX_FLAGS=-mcpu=apple-m2"
  #           wheel_name: macos-metal
  #           python_version: "3.14"
  #         # Linux with CUDA
  #         # - os: ubuntu-latest
  #         #   name: Linux-CUDA
  #         #   cmake_args: "-DGGML_CUDA=on -DGGML_CUDA_FORCE_CUBLAS=on"
  #         #   wheel_name: linux-cuda
  #         #   python_version: "3.14"
  #         #   cuda: "13.0.2"
  #         # # Linux with Vulkan
  #         # - os: ubuntu-latest
  #         #   name: Linux-Vulkan
  #         #   cmake_args: "-DGGML_VULKAN=on"
  #         #   wheel_name: linux-vulkan
  #         #   python_version: "3.14"
  #         # Windows with CUDA
  #         # - os: windows-latest
  #         #   name: Windows-CUDA
  #         #   cmake_args: "-DGGML_CUDA=on"
  #         #   wheel_name: windows-cuda
  #         #   python_version: "3.14"
  #         #   cuda: "13.0.2"
  #         # # Windows with Vulkan
  #         # - os: windows-latest
  #         #   name: Windows-Vulkan
  #         #   cmake_args: "-DGGML_VULKAN=on"
  #         #   wheel_name: windows-vulkan
  #         #   python_version: "3.14"

  #   runs-on: ${{ matrix.os }}
  #   name: Build Wheel - ${{ matrix.name }}

  #   steps:
  #   - uses: actions/checkout@v4

  #   - name: Set up Python
  #     uses: actions/setup-python@v5
  #     with:
  #       python-version: ${{ matrix.python_version }}

    # # Platform-specific setup
    # - name: Install CUDA Toolkit (CUDA builds)
    #   if: contains(matrix.cmake_args, 'CUDA')
    #   uses: Jimver/cuda-toolkit@v0.2.29
    #   id: cuda-toolkit
    #   with:
    #     cuda: ${{ matrix.cuda }}

    # - name: Cache CUDA Toolkit
    #   if: contains(matrix.cmake_args, 'CUDA')
    #   uses: actions/cache@v4
    #   with:
    #     path: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}  # Full toolkit dir (e.g., C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0)
    #     key: cuda-toolkit-${{ matrix.cuda }}-${{ runner.os }}-${{ hashFiles('**/requirements.txt', '**/setup.py') }}  # Stable key; add deps files if they affect builds
    #     restore-keys: |
    #       cuda-toolkit-${{ matrix.cuda }}-${{ runner.os }}-

    # - name: Install Vulkan SDK (Vulkan builds)
    #   if: contains(matrix.cmake_args, 'VULKAN')
    #   uses: humbletim/setup-vulkan-sdk@v1.2.1
    #   with:
    #      vulkan-query-version: 1.4.304.1
    #      # vulkan-components: Vulkan-Headers, Glslang, SPIRV-Tools
    #      vulkan-use-cache: true

    # - name: Install build dependencies
    #   run: |
    #     python -m pip install --upgrade pip
    #     pip install wheel setuptools build

    # - name: Build llama-cpp-python wheel
    #   env:
    #     CMAKE_ARGS: ${{ matrix.cmake_args }}
    #   run: |
    #     pip wheel llama-cpp-python --no-deps -w ./wheels

    # - name: Upload wheel artifact
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: wheel-${{ matrix.wheel_name }}
    #     path: wheels/*.whl
    #     retention-days: 7

  # Build Flet App using Wheels
  build-flet-apps:
    # needs: build-wheels
    strategy:
      matrix:
        include:
          # macOS app with Metal wheel
          - os: macos-latest
            wheel_artifact: wheel-macos-metal
            platform: macos
            app_name: WebSearchAI-macOS
            cmake_args: "-DGGML_METAL=on -DGGML_NATIVE=off -DCMAKE_C_FLAGS=-mcpu=apple-m2 -DCMAKE_CXX_FLAGS=-mcpu=apple-m2"

          # Android app
          # - os: ubuntu-latest
          #   platform: apk
          #   app_name: WebSearchAI-Android
          #   cmake_args: "-DGGML_NATIVE=off"
          
          # # Linux app with CUDA wheel
          # - os: ubuntu-latest
          #   wheel_artifact: wheel-linux-cuda
          #   platform: linux
          #   app_name: WebSearchAI-Linux-CUDA

          # # Linux app with Vulkan wheel
          # - os: ubuntu-latest
          #   wheel_artifact: wheel-linux-vulkan
          #   platform: linux
          #   app_name: WebSearchAI-Linux-Vulkan

          # Windows app with CUDA wheel
          - os: windows-latest
            wheel_artifact: wheel-windows-cuda
            platform: windows
            app_name: WebSearchAI-Windows-CUDA
            cmake_args: "-DGGML_CUDA=on"

          # # Windows app with Vulkan wheel
          # - os: windows-latest
          #   wheel_artifact: wheel-windows-vulkan
          #   platform: windows
          #   app_name: WebSearchAI-Windows-Vulkan


          # Platform-specific setup
          - name: Install CUDA Toolkit (CUDA builds)
            if: contains(matrix.cmake_args, 'CUDA')
            uses: Jimver/cuda-toolkit@v0.2.29
            id: cuda-toolkit
            cuda: 13.0.2

          # - name: Cache CUDA Toolkit
          #   if: contains(matrix.cmake_args, 'CUDA')
          #   uses: actions/cache@v4
          #   with:
          #     path: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}  # Full toolkit dir (e.g., C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v13.0)
          #     key: cuda-toolkit-${{ matrix.cuda }}-${{ runner.os }}-${{ hashFiles('**/requirements.txt', '**/setup.py') }}  # Stable key; add deps files if they affect builds
          #     restore-keys: |
          #       cuda-toolkit-${{ matrix.cuda }}-${{ runner.os }}-

    runs-on: ${{ matrix.os }}
    name: Build App - ${{ matrix.app_name }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.14"

    # - name: Download wheel
    #   uses: actions/download-artifact@v4
    #   with:
    #     name: ${{ matrix.wheel_artifact }}
    #     path: ./wheels

    # - name: Install wheel directly
    #   run: |
    #     WHEEL_FILE=$(ls wheels/*.whl | head -n 1)
    #     pip install $WHEEL_FILE

    - name: Create temporary pyproject.toml with wheel reference
      run: |
        # Get the wheel filename
        # WHEEL_FILE=$(ls wheels/*.whl | head -n 1)
        # WHEEL_PATH=$(realpath $WHEEL_FILE)

        # Create a modified pyproject.toml that references the local wheel
        cat > pyproject_build.toml << EOF
        [project]
        name = "websearch-ai"
        version = "0.1.0"
        description = ""
        readme = "README.md"
        requires-python = ">=3.9"
        authors = [
            { name = "DrinkingPants74", email = "drinkingpants74ose@gmail.com" }
        ]
        dependencies = [
            "flet>=0.28.3",
            "llama-cpp-python",
            "httpx",
            "beautifulsoup4",
            "readability-lxml",
            "pypng",
            "numpy",
          ]

        [tool.flet]
        org = "com.OneShotEntertainment"
        product = "WebSearch AI"
        company = "One Shot Entertainment"
        copyright = "GPLv3"

        [tool.flet.macos]
        build_arch = "arm64"

        [tool.flet.android]
        build_arch = "arm64"
        EOF

        # Backup original and use the build version
        mv pyproject.toml pyproject_original.toml || true
        mv pyproject_build.toml pyproject.toml
      shell: bash

    - name: Install Flet # and dependencies
      run: |
        pip install flet

    - name: Build Flet app
      env:
        CMAKE_ARGS: ${{ matrix.cmake_args }}
        PIP_NO_BINARY: "llama-cpp-python"
      run: |
        flet build ${{ matrix.platform }}

    - name: Upload app artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-${{ matrix.app_name }}
        path: |
          build/${{ matrix.platform }}/*
        retention-days: 30

  # Create release with all artifacts
  release:
    needs: build-flet-apps
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download all app artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: app-*
        path: apps

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          apps/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
